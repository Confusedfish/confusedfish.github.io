<!DOCTYPE html>
<!--
    Forty by HTML5 UP
    html5up.net | @ajlkn
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

{% include head.html %}

<body>

    {% include header.html %}
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.31.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.31.0/mapbox-gl.css' rel='stylesheet' />


    <!-- Main -->
    <div id="main" class="alt">

        <!-- One -->
        <section id="one">
            <div class="inner">
                <header class="major">
                    <h1>
                        {% if page.planning %}
                        <a href="/future.html">Future Plans</a> <i class="fa fa-angle-double-right" aria-hidden="true"></i>
                        {% endif %}
                        {{ page.title }}
                    </h1>
                </header>
                {% if page.image %}
                <span class="image main">
                    <img src="{{ page.image }}" alt="" />
                    {% if page.image-caption %}<span class="image caption">{{ page.image-caption }}</span>{% endif %}
                </span>{% endif %}

                <p>{{ content }}</p>

                <div id="map" style="width: 100%; height:300px; margin-bottom: 10px;"></div>

                {% assign subPosts = (site.posts | where: 'group', page.group) | sort: 'date' %}
                <button id="btnPreviousStep">Previous Step</button>
                <button id="btnNextStep">Next Step</button><br />
                {% for subpage in subPosts %}
                {% if subpage != page %}
                <div class="planningDetail" id="{{ subpage.id }}">
                    <h3>
                        {{ subpage.title }}
                    </h3>
                    <small>{{ subpage.description  }}</small>
                    <p>{{ subpage.content | markdownify  }}</p>
                </div>
                {% endif %}
                {% endfor %}

                <a href="{{ page.planning-sheet }}" class="button big icon fa-table" target="_blank">Planning Sheet</a>

            </div>
        </section>

    </div>

    {% include footer.html %}


    <script>

        var stepSettings = new Array();
        {% for subpage in subPosts %}
        {% if subpage != page %}
        stepSettings.push({
            filter: {% if subpage.map-filter %}{{ subpage.map-filter }}{%else%}null{%endif%},
            bounds: {% if subpage.map-bounds %}{{ subpage.map-bounds }}{%else%}null{%endif%}
        });
        {% endif %}
        {% endfor %}


        var currentStep = 0;
        var maxStep = $('.planningDetail').length-1;
        $(function () {
            $('#btnPreviousStep').click(function () {
                currentStep--;
                if (currentStep < 0)
                    currentStep = 0;
                setVisibleStep();
            });

            $('#btnNextStep').click(function () {
                currentStep++;
                if (currentStep > maxStep)
                    currentStep = maxStep;
                setVisibleStep();
            });
        });

        function setVisibleStep() {
            $('.planningDetail').toggle(false);
            $('.planningDetail').eq(currentStep).toggle(true);

            $('#btnPreviousStep').prop('disabled', (currentStep == 0));
            $('#btnNextStep').prop('disabled', (currentStep == maxStep));

            var settings = stepSettings[currentStep];
            map.setFilter("tile-data",settings.filter);
            if(settings.bounds){
                var bounds = new mapboxgl.LngLatBounds(
                    new mapboxgl.LngLat(settings.bounds[0][0],settings.bounds[0][1]),
                    new mapboxgl.LngLat(settings.bounds[1][0],settings.bounds[1][1]));
                map.fitBounds(bounds);
            }
        }

    mapboxgl.accessToken = "{{ page.map-token }}";
    var map = new mapboxgl.Map({
        container: 'map',
        style: '{{ page.map-style }}',
        zoom: 0,
        center: [-1.688411,53.348632]
    });

    {% if page.map-bounds %}
    var defaultBounds = {{ page.map-bounds }};
    var bounds = new mapboxgl.LngLatBounds(
        new mapboxgl.LngLat(defaultBounds[0][0],defaultBounds[0][1]),
        new mapboxgl.LngLat(defaultBounds[1][0],defaultBounds[1][1]));
    map.fitBounds(bounds);
    {% endif %}


    var mapDataLayer;
    map.on('load', function () {
        map.addLayer({
            "id": "tile-data",
            "type": "line",
            "source": {
                type: 'vector',
                url: 'mapbox://{{ page.map-tileset }}'
            },
            "source-layer": '{{ page.map-layer }}',
            "layout": {
                "line-join": "round",
                "line-cap": "round"
            },
            "paint": {
                "line-color": {
                    property: 'transport',
                    type: 'categorical',
                    stops: [
                        ['car', '#008030'],
                        ['plane', '#b05080']
                    ]
                    },
                "line-width": 3
            }
        });
    });

    var filterLoaded = false;
    map.on('data',function(d){
        $('.planningDetail').toggle(false);
        $('.planningDetail').eq(0).toggle(true);
        {% if page.map-filter %}
        if(!filterLoaded && d.dataType=="style" && d.style._loaded && map.getLayer("tile-data")!=null    )
        {
            console.log('Setting initial filter');
            map.setFilter("tile-data",{{page.map-filter}});
            filterLoaded = true;
        }
        {% endif %}
    });


    </script>

</body>

</html>